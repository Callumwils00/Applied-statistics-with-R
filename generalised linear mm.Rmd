---
title: "Generalised linear mixed effects models tutorial"
output: html_document
---

```{r}
library(NHSRdatasets)
library(ggplot2)
library(ggiraphExtra)
library(dplyr)
library(tidyverse)
library(lme4)
library(jtools)


Data <- NHSRdatasets::LOS_model
```
This dataset shows simulated length of hospital stay as and Age data as well as outcome(whether they died or not)from an NHS R training package NHSRdatasets. The data was collected across 10 trusts, and is potentially not independent (ie. length of stay(LOS), could be correlated within trusts). However, this first analysis assumes independence to show how to construct a generalized linear model with poisson and binomial outcome data.


0. Visualising data: Scatterplot of length of stay against age with colors showing each trust
```{r}
ggplot(Data, aes(Age, LOS, color)) + geom_point()
```

QQNORM to visualize distribution
```{r}
qqnorm(Data$LOS) ##Not normal
```


```{r}
hist(Data$LOS, xlab = "LOS", ylab = "frequency") ## poisson distribution 
```

```{r}
hist(Data$Age, xlab = "Age", ylab = "frequency")## distribution of predictors is not as important, we don't make assumptions about the predictors.
```
1.  Generalized linear model Use generalized linear model as the data is not normally distributed.

```{r}
## Specifying poisson distribution in the model
Los.glm <- glm(LOS ~ Age * Death, data = Data, family = "poisson"(link = log))

## The coefficients are the log of the predicted values
summary(Los.glm)
## signitifcant positive effects of Age and Death on LOS
```


If we only had one predictor we could plot the model with the data points like so
```{r}
##using effect_plot from jtools to visualise the model 
effect_plot(Los.glm, pred = Age, interval = TRUE)
```
```{r}
effect_plot(Los.glm, pred = Death, interval = TRUE)
```

logistic glm using the logit link function for binomial data. Death is a binomial variable (either 1 or 0)
```{r}
logglm <- glm(Death ~ Age * LOS, data = Data, family = binomial(link = "logit"))
summary(logglm)
```
We can use ggPredict from the ggiraphExtra package to visualise the effect of age on death across different LOS brackets
```{r}
ggPredict(logglm,se=TRUE,interactive=TRUE)
```

